name: upsun

project_files:
  - upsun/install-hook.php
  - upsun/UpsunConfigParser.php
  - upsun/DdevConfigGenerator.php
  - upsun/debug-parser.php

pre_install_actions:
  - |
    <?php
    # #ddev-description Check for Redis service dependency (lightweight detection)
    $projectRoot = realpath('..');
    $upsunDir = $projectRoot . '/.upsun';
    
    if (is_dir($upsunDir)) {
        // Look for Redis service in Upsun config files
        $configFile = $upsunDir . '/config.yaml';
        $appFile = $upsunDir . '/.platform.app.yaml';
        
        $hasRedis = false;
        
        // Check both possible config locations
        foreach ([$configFile, $appFile] as $file) {
            if (file_exists($file)) {
                $content = file_get_contents($file);
                // Simple regex to detect Redis service definition
                if (preg_match('/^\s*redis:\s*$/m', $content) || 
                    preg_match('/type:\s*redis/m', $content)) {
                    $hasRedis = true;
                    break;
                }
            }
        }
        
        if ($hasRedis) {
            echo "âœ… Detected Redis service in .upsun configuration\n";
            echo "ðŸ“¦ Adding ddev-redis as dynamic dependency\n";
            file_put_contents('./.runtime-deps-upsun', "ddev/ddev-redis\n", FILE_APPEND);
        }
    }

post_install_actions:
  - |
    <?php
    # #ddev-description Initialize Upsun configuration
    require_once('upsun/install-hook.php');
  - |
    <?php
    # #ddev-description Debug Upsun configuration parsing
    # require_once('upsun/debug-parser.php');

removal_actions:
  - |
    <?php
    # #ddev-description Remove Upsun-generated files
    echo "=== Upsun add-on removal cleanup ===\n";
    $files_to_remove = [
      'config.upsun.yaml',
      'web-build/Dockerfile.upsun'
    ];
    
    foreach ($files_to_remove as $file) {
      if (file_exists($file)) {
        $content = file_get_contents($file);
        if (strpos($content, '#ddev-generated') !== false) {
          if (unlink($file)) {
            echo "âœ… Removed: $file\n";
          } else {
            echo "âŒ Failed to remove: $file\n";
          }
        } else {
          echo "âš ï¸  Skipped: $file (not #ddev-generated)\n";
        }
      } else {
        echo "â„¹ï¸  Not found: $file\n";
      }
    }
    
    // Clean up empty web-build directory
    if (is_dir('web-build')) {
      $files = array_diff(scandir('web-build'), ['.', '..']);
      if (empty($files)) {
        if (rmdir('web-build')) {
          echo "âœ… Removed empty directory: web-build\n";
        }
      }
    }
    echo "=== Cleanup completed ===\n";

ddev_version_constraint: '>= v1.24.3'
