applications:
  drupal:
    source:
      root: /
    type: php:8.3
    build:
      flavor: composer
    # Installs global dependencies as part of the build process. They're independent of your app's dependencies and
    # are available in the PATH during the build process and in the runtime environment. They're installed before
    # the build hook runs using a package manager for the language.
    # More information: https://docs.upsun.com/create-apps/app-reference/single-runtime-image.html#dependencies
    dependencies:
      nodejs:
        n: "*"
        npx: "*"
        yarn: "^1.22.0"
      php:
        composer/composer: "^2"

    web:
      locations:
        "/":
          root: "web"
          expires: 5m
          passthru: "/index.php"
          allow: false
          rules:
            '\.(avif|webp|jpe?g|png|gif|svgz?|css|js|map|ico|bmp|eot|woff2?|otf|ttf)$':
              allow: true
            '^/robots\.txt$':
              allow: true
            '^/sitemap\.xml$':
              allow: true
            '^/sites/sites\.php$':
              scripts: false
            '^/sites/[^/]+/settings.*?\.php$':
              scripts: false
        "/sites/default/files":
          root: "web/sites/default/files"
          allow: true
          expires: 5m
          passthru: "/index.php"
          scripts: false
          rules:
            '^/sites/default/files/(css|js)':
              expires: 2w
    variables:
      env:
        N_PREFIX: "/app/.global"

    mounts:
      "/web/sites/default/files": "shared:files/files"
      "/tmp": "shared:files/tmp"
      "/private": "shared:files/private"
      "/.drush": "shared:files/drush"
      "/drush-backups": "shared:files/drush-backups"
    relationships:
      mariadb: "mariadb:mysql"
      redis: 'cache:redis'
      opensearch: 'search:opensearch'
      memcached: 'memory:memcached'

    hooks:
      build: |
        set -e
        # fast.
      deploy: |
        set -e
        php ./drush/upsun_generate_drush_yml.php
        cd web
        bash $PLATFORM_APP_DIR/drush/upsun_deploy_drupal.sh

    runtime:
      # Enable the redis extension so Drupal can communicate with the Redis cache.
      extensions:
        - redis
        - sodium
        - apcu
        - blackfire

services:
  mariadb:
    type: mariadb:11.8
  cache:
    type: redis:8.0
  search:
    type: opensearch:3
  memory:
    type: memcached:1.6

routes:
  "https://{default}/":
    type: upstream
    upstream: "drupal:http"
